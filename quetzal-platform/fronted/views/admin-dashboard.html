<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Quetzal Platform</title>
    <link rel="stylesheet" href="../public/css/main.css">
    <link rel="stylesheet" href="../public/css/components.css">
    <link rel="stylesheet" href="../public/css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <h2>ü¶ú Admin Panel</h2>
            <nav class="admin-nav">
                <a href="admin-dashboard.html" class="active">üìä Dashboard</a>
                <a href="admin-users.html">üë• Usuarios</a>
                <a href="admin-services.html">‚ö° Servicios</a>
                <a href="admin-reports.html">üìà Reportes</a>
                <a href="admin-transactions.html">üí∞ Transacciones</a>
                <a href="admin-settings.html">‚öôÔ∏è Configuraci√≥n</a>
                <hr style="margin: 1rem 0; border-color: #34495e;">
                <a href="dashboard.html">üîô Vista Usuario</a>
                <a href="#" onclick="logout()">üö™ Cerrar Sesi√≥n</a>
            </nav>
        </aside>

        <!-- Contenido Principal -->
        <main class="admin-main">
            <div class="admin-header">
                <div>
                    <h1>Dashboard de Administraci√≥n</h1>
                    <p>Bienvenido, <span id="adminName">Administrador</span></p>
                </div>
                <div>
                    <span id="currentDate"></span>
                </div>
            </div>

            <!-- Estad√≠sticas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="totalUsers">-</div>
                    <div class="stat-label">Total Usuarios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-value" id="totalServices">-</div>
                    <div class="stat-label">Servicios Activos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value" id="totalTransactions">-</div>
                    <div class="stat-label">Transacciones</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíµ</div>
                    <div class="stat-value" id="totalRevenue">Q 0</div>
                    <div class="stat-label">Ingresos Totales</div>
                </div>
            </div>

            <!-- Gr√°ficos -->
            <div class="chart-container">
                <h2>Actividad de Usuarios (√öltimos 7 d√≠as)</h2>
                <canvas id="userActivityChart" style="max-height: 300px;"></canvas>
            </div>

            <!-- Actividad Reciente -->
            <div class="recent-activity">
                <h2>Actividad Reciente</h2>
                <div id="activityList">
                    <div class="loading">Cargando actividad...</div>
                </div>
            </div>
        </main>
    </div>

    <script src="../public/js/config.js"></script>
    <script src="../public/js/api.js"></script>
    <script src="../public/js/auth.js"></script>
    <script src="../public/js/app.js"></script>
    <script>
        // Verificar que sea admin
        const user = JSON.parse(localStorage.getItem('quetzal_user') || '{}');
        if (!user.role || user.role !== 'admin') {
            alert('No tienes permisos de administrador');
            window.location.href = 'dashboard.html';
        }

        // Mostrar nombre del admin
        document.getElementById('adminName').textContent = user.fullName || 'Administrador';

        // Fecha actual
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-GT', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Cargar estad√≠sticas
        async function loadStats() {
            try {
                // Cargar usuarios
                const usersResponse = await apiRequest('/api/admin/users');
                if (usersResponse.success) {
                    document.getElementById('totalUsers').textContent = usersResponse.data.length;
                }

                // Cargar servicios
                const servicesResponse = await apiRequest('/api/services');
                if (servicesResponse.success) {
                    const activeServices = servicesResponse.data.filter(s => s.isActive);
                    document.getElementById('totalServices').textContent = activeServices.length;
                }

                // Cargar transacciones
                const transactionsResponse = await apiRequest('/api/admin/transactions');
                if (transactionsResponse.success) {
                    document.getElementById('totalTransactions').textContent = transactionsResponse.data.length;
                    
                    // Calcular ingresos totales
                    const totalRevenue = transactionsResponse.data.reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                    document.getElementById('totalRevenue').textContent = `Q ${totalRevenue.toFixed(2)}`;
                }

            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        // Cargar actividad reciente
        async function loadRecentActivity() {
            const activityList = document.getElementById('activityList');
            
            try {
                const response = await apiRequest('/api/admin/activity');
                
                if (response.success && response.data.length > 0) {
                    activityList.innerHTML = response.data.slice(0, 10).map(activity => `
                        <div class="activity-item">
                            <div>
                                <strong>${activity.description}</strong>
                                <div style="color: #666; font-size: 0.9rem;">${activity.user}</div>
                            </div>
                            <div style="color: #666; font-size: 0.85rem;">
                                ${formatTimeAgo(activity.createdAt)}
                            </div>
                        </div>
                    `).join('');
                } else {
                    activityList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">No hay actividad reciente</p>';
                }
            } catch (error) {
                activityList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Error al cargar actividad</p>';
            }
        }

        // Formatear tiempo
        function formatTimeAgo(date) {
            const now = new Date();
            const past = new Date(date);
            const diffInSeconds = Math.floor((now - past) / 1000);
            
            if (diffInSeconds < 60) return 'Hace unos segundos';
            if (diffInSeconds < 3600) return `Hace ${Math.floor(diffInSeconds / 60)} minutos`;
            if (diffInSeconds < 86400) return `Hace ${Math.floor(diffInSeconds / 3600)} horas`;
            return `Hace ${Math.floor(diffInSeconds / 86400)} d√≠as`;
        }

        // Logout
        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                localStorage.removeItem('quetzal_token');
                localStorage.removeItem('quetzal_user');
                window.location.href = 'landing-page.html';
            }
        }

        // Cargar datos al iniciar
        loadStats();
        loadRecentActivity();

        // Actualizar cada 30 segundos
        setInterval(() => {
            loadStats();
            loadRecentActivity();
        }, 30000);
    </script>
</body>
</html>
