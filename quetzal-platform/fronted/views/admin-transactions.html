<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transacciones - Admin</title>
    <link rel="stylesheet" href="../public/css/main.css">
    <link rel="stylesheet" href="../public/css/components.css">
    <link rel="stylesheet" href="../public/css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <h2>ü¶ú Admin Panel</h2>
            <nav class="admin-nav">
                <a href="admin-dashboard.html">üìä Dashboard</a>
                <a href="admin-users.html">üë• Usuarios</a>
                <a href="admin-services.html">‚ö° Servicios</a>
                <a href="admin-reports.html">üìà Reportes</a>
                <a href="admin-transactions.html" class="active">üí∞ Transacciones</a>
                <hr style="margin: 1rem 0; border-color: #34495e;">
                <a href="dashboard.html">üîô Vista Usuario</a>
                <a href="#" onclick="logout()">üö™ Cerrar Sesi√≥n</a>
            </nav>
        </aside>

        <main class="admin-main">
            <h1>Gesti√≥n de Transacciones</h1>
            
            <div class="filters">
                <input type="text" id="searchInput" placeholder="Buscar por usuario..." 
                       style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                <select id="statusFilter" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all">Todos los estados</option>
                    <option value="completed">Completadas</option>
                    <option value="pending">Pendientes</option>
                    <option value="failed">Fallidas</option>
                </select>
                <select id="typeFilter" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all">Todos los tipos</option>
                    <option value="payment">Pagos</option>
                    <option value="deposit">Dep√≥sitos</option>
                    <option value="withdrawal">Retiros</option>
                </select>
                <button class="btn btn-primary" onclick="loadTransactions()">üîç Buscar</button>
            </div>

            <div class="transactions-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>De</th>
                            <th>Para</th>
                            <th>Tipo</th>
                            <th>Monto</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">
                                <div class="loading">Cargando transacciones...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script src="../public/js/config.js"></script>
    <script src="../public/js/api.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('quetzal_user') || '{}');
        if (user.role !== 'admin') {
            window.location.href = 'dashboard.html';
        }

        let allTransactions = [];

        async function loadTransactions() {
            try {
                const response = await apiRequest('/api/admin/transactions');
                
                if (response.success) {
                    allTransactions = response.data;
                    filterAndRenderTransactions();
                } else {
                    showError('No se pudieron cargar las transacciones');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error al cargar transacciones');
            }
        }

        function filterAndRenderTransactions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            let filtered = allTransactions;

            if (searchTerm) {
                filtered = filtered.filter(t => 
                    t.Sender?.fullName?.toLowerCase().includes(searchTerm) ||
                    t.Receiver?.fullName?.toLowerCase().includes(searchTerm) ||
                    t.Sender?.email?.toLowerCase().includes(searchTerm) ||
                    t.Receiver?.email?.toLowerCase().includes(searchTerm)
                );
            }

            if (statusFilter !== 'all') {
                filtered = filtered.filter(t => t.status === statusFilter);
            }

            if (typeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilter);
            }

            renderTransactions(filtered);
        }

        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactionsTableBody');
            
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No se encontraron transacciones</td></tr>';
                return;
            }

            tbody.innerHTML = transactions.map(t => `
                <tr>
                    <td><code>${t.id.substring(0, 8)}...</code></td>
                    <td>
                        <strong>${t.Sender?.fullName || 'N/A'}</strong><br>
                        <small style="color: #666;">${t.Sender?.email || ''}</small>
                    </td>
                    <td>
                        <strong>${t.Receiver?.fullName || 'N/A'}</strong><br>
                        <small style="color: #666;">${t.Receiver?.email || ''}</small>
                    </td>
                    <td><span class="badge">${t.type || 'payment'}</span></td>
                    <td><strong>Q${parseFloat(t.amount).toFixed(2)}</strong></td>
                    <td><span class="badge badge-${t.status}">${translateStatus(t.status)}</span></td>
                    <td>${new Date(t.createdAt).toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function translateStatus(status) {
            const translations = {
                'completed': 'Completada',
                'pending': 'Pendiente',
                'failed': 'Fallida'
            };
            return translations[status] || status;
        }

        function showError(message) {
            document.getElementById('transactionsTableBody').innerHTML = `
                <tr><td colspan="7" style="text-align: center; padding: 2rem; color: red;">
                    ${message}
                </td></tr>
            `;
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'landing-page.html';
        }

        document.getElementById('searchInput').addEventListener('input', filterAndRenderTransactions);
        document.getElementById('statusFilter').addEventListener('change', filterAndRenderTransactions);
        document.getElementById('typeFilter').addEventListener('change', filterAndRenderTransactions);

        loadTransactions();
    </script>
</body>
</html>
